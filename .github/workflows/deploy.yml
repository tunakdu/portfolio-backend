name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 300s
        script: |
          echo "🚀 GitHub Actions deployment başlatılıyor..."
          cd /home/tunakdu/web/akduhan.com/public_html
          
          # SSL sertifikalarını ve önemli dosyaları koru
          cp -r ssl ssl_backup 2>/dev/null || true
          cp .env .env_backup 2>/dev/null || true
          
          # Git repository'yi temizle ve güncelle
          git reset --hard HEAD
          git clean -fd -e ssl/ -e .env -e storage/
          git pull origin master
          
          # Korunan dosyaları geri getir
          cp -r ssl_backup/* ssl/ 2>/dev/null || true
          cp .env_backup .env 2>/dev/null || true
          rm -rf ssl_backup .env_backup
          
          # MySQL SSL sertifikalarını kontrol et ve yükle
          echo "🔍 SSL durumu kontrol ediliyor..."
          mkdir -p ssl
          
          if [ ! -f "ssl/ca.pem" ] || [ ! -s "ssl/ca.pem" ]; then
            echo "🔐 MySQL SSL sertifikaları yükleniyor..."
            
            # Doğrudan MySQL için gerekli SSL sertifikasını oluştur
            cat > ssl/ca.pem << 'EOF'
          -----BEGIN CERTIFICATE-----
          MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF
          ADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6
          b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTEL
          MAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJv
          b3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXj
          ca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM
          9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qw
          IFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6
          VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L
          93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQm
          jgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMC
          AYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUA
          A4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDI
          U5PMCCjjmCXPI6T53iHTfIuJruydjsw2hUwsOBMhbgLNHgr48bvCfpCKxWvV9s3P
          B8YPJ3zHzGiJvEtHk/8yI+YHcCK5RNbQMEsw0bhsNMhfHAT0T6NPwNvbAAJRhZcG
          veDON2gSW3HOuPepHU9DxtTZ5Rj4B4aNnDdqN6oqQdZhSKGRANtYe4k5K+yHc2DZ
          7iCt1oqgvGHJTyJxb3qtJlb9qQwt8S8X5mF5XHXE6d8U6vTpxZGLmINd7w8R3mQV
          WrBQR9jSHdl5ry8I2CgVF7Gw
          -----END CERTIFICATE-----
          EOF
            
            echo "✅ SSL sertifikası oluşturuldu: $(wc -l < ssl/ca.pem) satır"
          else
            echo "✅ SSL sertifikası zaten mevcut: $(wc -l < ssl/ca.pem) satır"
          fi
          
          # SSL dosyasını kontrol et
          if openssl x509 -in ssl/ca.pem -text -noout >/dev/null 2>&1; then
            echo "✅ SSL sertifikası geçerli"
          else
            echo "⚠️ SSL sertifikası geçersiz, yeniden oluşturuluyor..."
            rm -f ssl/ca.pem
            echo "-----BEGIN CERTIFICATE-----" > ssl/ca.pem
            echo "MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsF" >> ssl/ca.pem
            echo "-----END CERTIFICATE-----" >> ssl/ca.pem
          fi
          
          # Deploy script'i çalıştırılabilir yap
          chmod +x deploy.sh
          
          # Deploy script'i çalıştır
          ./deploy.sh
          
          echo "✅ GitHub Actions deployment tamamlandı!"