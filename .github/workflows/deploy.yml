name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: Deploy to server
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          cd /home/tunakdu/web/akduhan.com/public_html

          echo "ðŸ”„ Deployment baÅŸlatÄ±lÄ±yor..."

          # Ã‡AKIÅžMA TESPÄ°TÄ° - BaÅŸka deploy sistemi Ã§alÄ±ÅŸÄ±yor mu?
          echo "ðŸ” Ã‡akÄ±ÅŸan deploy sistemleri kontrol ediliyor..."

          # Git process kontrolÃ¼
          GIT_PROCESSES=$(ps aux | grep -v grep | grep -c "git pull\|git fetch\|git checkout" || echo "0")
          if [ "$GIT_PROCESSES" -gt "0" ]; then
            echo "âš ï¸ BaÅŸka git iÅŸlemi tespit edildi, bekleniyor..."
            sleep 5
          fi

          # Lock file oluÅŸtur
          LOCK_FILE="/tmp/deploy.lock"
          if [ -f "$LOCK_FILE" ]; then
            echo "âš ï¸ BaÅŸka deployment Ã§alÄ±ÅŸÄ±yor (lock file mevcut), bekleniyor..."
            rm -f "$LOCK_FILE" # Eski lock'u temizle
          fi
          echo $ > "$LOCK_FILE"

          # Deploy indicator oluÅŸtur
          echo "$(date): GitHub Action Deploy Started" > .deploy-status

          # Supervisor worker'larÄ±nÄ± zarif bir ÅŸekilde durdur
          echo "â¸ï¸  Supervisor worker'larÄ± durduruluyor..."
          sudo supervisorctl stop laravel-worker:* || true
          sudo supervisorctl stop laravel-scheduler || true

          # Git pull latest changes (sadece kodu gÃ¼ncelle)
          echo "ðŸ“¥ Kod gÃ¼ncellemeleri alÄ±nÄ±yor..."
          git pull origin master

          # Install/Update Composer dependencies (production optimized)
          echo "ðŸ“¦ Composer dependencies gÃ¼ncelleniyor..."
          composer install --no-dev --optimize-autoloader --no-interaction

          # Install/Update NPM dependencies and build assets
          echo "ðŸ—ï¸  Assets build ediliyor..."
          npm install --production
          npm run build

          # MySQL SSL dosyalarÄ±nÄ± koru/kopyala (her deploy sonrasÄ±)
          echo "ðŸ” SSL dosyalarÄ± kontrol ediliyor..."
          mkdir -p ssl/
          if [ ! -f ssl/ca.pem ]; then
            cp /etc/mysql/ssl/ca.pem ssl/ 2>/dev/null || echo "SSL dosyasÄ± bulunamadÄ±: ca.pem"
          fi
          if [ ! -f ssl/server-cert.pem ]; then
            cp /etc/mysql/ssl/server-cert.pem ssl/ 2>/dev/null || echo "SSL dosyasÄ± bulunamadÄ±: server-cert.pem"
          fi
          if [ ! -f ssl/server-key.pem ]; then
            cp /etc/mysql/ssl/server-key.pem ssl/ 2>/dev/null || echo "SSL dosyasÄ± bulunamadÄ±: server-key.pem"
          fi

          # SSL dosya izinlerini ayarla
          if [ -d ssl/ ]; then
            chmod 644 ssl/*.pem 2>/dev/null || true
            chmod 755 ssl/
            chown -R www-data:www-data ssl/ 2>/dev/null || true
          fi

          # Laravel cache'lerini temizle (Ã–NCE TEMÄ°ZLE)
          echo "ðŸ§¹ Cache temizleniyor..."
          php artisan config:clear || true
          php artisan cache:clear || true
          php artisan view:clear || true
          php artisan route:clear || true
          php artisan queue:clear || true

          # Run database migrations
          echo "ðŸ—„ï¸  Database migration'larÄ± Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
          php artisan migrate --force

          # KAPSAMLI DOSYA Ä°ZÄ°NLERÄ° DÃœZELTMESÄ°
          echo "ðŸ“ KapsamlÄ± dosya izinleri ayarlanÄ±yor..."

          # Ana dizin sahipliÄŸi
          sudo chown -R tunakdu:www-data ./

          # Kritik dizinler iÃ§in Ã¶zel izinler
          sudo chmod -R 755 ./
          sudo chmod -R 775 storage/
          sudo chmod -R 775 bootstrap/cache/
          sudo chmod -R 755 database/
          sudo chmod -R 755 database/migrations/
          sudo chmod -R 755 app/
          sudo chmod -R 755 config/
          sudo chmod -R 755 routes/
          sudo chmod -R 755 resources/

          # Artisan executable olsun
          sudo chmod +x artisan

          # Log dosyalarÄ± yazÄ±labilir olsun
          sudo chmod -R 666 storage/logs/*.log 2>/dev/null || true

          # .env dosyasÄ± gÃ¼venli ama okunabilir olsun
          sudo chmod 644 .env

          # Composer ve NPM cache dizinleri
          sudo chmod -R 755 vendor/ 2>/dev/null || true
          sudo chmod -R 755 node_modules/ 2>/dev/null || true

          echo "âœ… Dosya izinleri dÃ¼zeltildi"

          # Production iÃ§in cache optimizasyonlarÄ± (SONRA CACHE'LE)
          echo "âš¡ Production cache oluÅŸturuluyor..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

          # Supervisor konfigÃ¼rasyonlarÄ±nÄ± yeniden yÃ¼kle
          echo "ðŸ”„ Supervisor konfigÃ¼rasyonlarÄ± gÃ¼ncelleniyor..."
          sudo supervisorctl reread
          sudo supervisorctl update

          # Queue worker'larÄ±nÄ± yeniden baÅŸlat
          echo "ðŸš€ Supervisor worker'larÄ± baÅŸlatÄ±lÄ±yor..."
          sudo supervisorctl start laravel-worker:*
          sudo supervisorctl start laravel-scheduler

          # Worker durumlarÄ±nÄ± kontrol et
          echo "âœ… Worker durumlarÄ± kontrol ediliyor..."
          sudo supervisorctl status

          # Queue restart ile mevcut worker'larÄ± zarif ÅŸekilde yeniden baÅŸlat
          echo "ðŸ”„ Queue worker'larÄ± yenileniyor..."
          php artisan queue:restart

          # POST-DEPLOYMENT VALIDATION
          echo "ðŸ” Deployment doÄŸrulamasÄ± yapÄ±lÄ±yor..."

          # Kritik dosyalarÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
          echo "ðŸ“„ Kritik dosya kontrolleri:"
          [ -f artisan ] && echo "âœ… artisan" || echo "âŒ artisan eksik"
          [ -f .env ] && echo "âœ… .env" || echo "âŒ .env eksik"
          [ -d storage ] && echo "âœ… storage/" || echo "âŒ storage/ eksik"
          [ -d bootstrap/cache ] && echo "âœ… bootstrap/cache/" || echo "âŒ bootstrap/cache/ eksik"

          # Yazma izinleri kontrol et
          echo "ðŸ” Yazma izinleri kontrolleri:"
          [ -w storage ] && echo "âœ… storage yazÄ±labilir" || echo "âŒ storage yazÄ±lamaz"
          [ -w bootstrap/cache ] && echo "âœ… bootstrap/cache yazÄ±labilir" || echo "âŒ bootstrap/cache yazÄ±lamaz"
          [ -w database/migrations ] && echo "âœ… migrations yazÄ±labilir" || echo "âŒ migrations yazÄ±lamaz"

          # Artisan komutlarÄ±nÄ± test et
          echo "âš™ï¸ Artisan komut testleri:"
          php artisan --version > /dev/null && echo "âœ… Artisan Ã§alÄ±ÅŸÄ±yor" || echo "âŒ Artisan hatasÄ±"

          # Migration yetenekleri test et
          echo "ðŸ—„ï¸ Migration test:"
          php artisan migrate:status > /dev/null && echo "âœ… Migration sistem Ã§alÄ±ÅŸÄ±yor" || echo "âŒ Migration sistem hatasÄ±"

          # IMAP baÄŸlantÄ±sÄ±nÄ± test et
          echo "ðŸ“§ IMAP baÄŸlantÄ±sÄ± test ediliyor..."
          php artisan tinker --execute="
          try {
              \$imap = new App\\Services\\ImapService();
              \$result = \$imap->testConnection();
              echo \$result['success'] ? 'âœ… IMAP baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±' : 'âŒ IMAP hatasÄ±: ' . \$result['message'];
              echo \"\n\";
          } catch (Exception \$e) {
              echo 'âŒ IMAP test hatasÄ±: ' . \$e->getMessage() . \"\n\";
          }
          "

          # Son durum raporu
          echo ""
          echo "ðŸ“Š DEPLOYMENT RAPORU:"
          echo "===================="
          echo "ðŸ“§ IMAP Host: $(grep IMAP_HOST .env | cut -d '=' -f2)"
          echo "ðŸ‘¤ IMAP User: $(grep IMAP_USERNAME .env | cut -d '=' -f2)"
          echo "ðŸ”§ Supervisor Status:"
          sudo supervisorctl status | grep laravel
          echo "===================="

          echo "ðŸš€ Deployment baÅŸarÄ±yla tamamlandÄ±!"

          # Deploy tamamlandÄ± indicator
          echo "$(date): GitHub Action Deploy Completed Successfully" > .deploy-status

          # Lock file temizle
          rm -f "/tmp/deploy.lock"