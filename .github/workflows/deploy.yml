name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 300s
        script: |
          echo "🚀 GitHub Actions deployment başlatılıyor..."
          cd /home/tunakdu/web/akduhan.com/public_html
          
          # Sadece .env dosyasını koru, SSL'i yeniden oluşturacağız
          cp .env .env_backup 2>/dev/null || true
          
          # Git repository'yi temizle ve güncelle
          git reset --hard HEAD
          git clean -fd -e .env -e storage/
          git pull origin master
          
          # .env dosyasını geri getir
          cp .env_backup .env 2>/dev/null || true
          rm -f .env_backup
          
          # MySQL SSL sertifikalarını zorla yeniden oluştur
          echo "🔐 MySQL SSL sertifikaları yeniden oluşturuluyor..."
          rm -rf ssl
          mkdir -p ssl
          
          # Geçerli bir SSL sertifikası oluştur
          cat > ssl/ca.pem << 'EOF'
          -----BEGIN CERTIFICATE-----
          MIIEBjCCAu6gAwIBAgIJAMc0ZzaSUK51MA0GCSqGSIb3DQEBBQUAMIGYMQswCQYD
          VQQGEwJVUzELMAkGA1UECAwCQ0ExFjAUBgNVBAcMDU1vdW50YWluIFZpZXcxFDAS
          BgNVBAoMC1BheVBhbCBJbmMuMRMwEQYDVQQLDApzYW5kYm94XzIwMTQxNDAyBgNV
          BAMMK3NhbmRib3gyMDE0LnNhbmRib3gucGF5cGFsLmNvbTCCASIwDQYJKoZIhvcN
          AQEBBQADggEPADCCAQoCggEBAOFpkpFcxrJckHl1MwTlWJIDuqSI2UwIAnNllkzH
          4DtEsKp+2o7r4D2Pyz/FPaQGJK0gP6KZlhq/WgfYVMdVGkh1KZ1PmMH9DRF8bS1n
          iY6BHj0GWzUOQ+FVHVkBYJl9hKr3mG0XSVhUGaYm6ZO6Ys8TBYwPw7Hf4eaY6fYF
          rXYT9Wt+r4xN9bUKKvE1kVfOPGUVn+Jp9WJ/aVGl6Vj8kL+lrZm9qQTyYdC2RqE3
          8eIWOUG2KZN5Z+vf4H6L3nP7Y+X9hGxlrBTzrg9PZfZ9K3zS8fGz5MZG2f+g3LgY
          nBzx3jYbVQOYYe8WcwNuQhDxRuDrqYJ5sY8jJYpnT9a3PucCAwEAAaNQME4wHQYD
          VR0OBBYEFNVuUqG8T7zK7LQ7zGGhm9q3xc+DMB8GA1UdIwQYMBaAFNVuUqG8T7zK
          7LQ7zGGhm9q3xc+DMAkGA1UdEwQCMAAwDQYJKoZIhvcNAQEFBQADggEBAJp3wPjl
          qZlZcZ+jDEVi1vVjlkUl0WvqA9sJzElwfN8fkqPNIyQ9Lw/+e7nT6XsWLwN3n3fR
          RYqK2g3UzGzKnV7m2b8k4qRj1H8jt9j5r7l4mQQWJKwvGNzH5VkrDu8VzPfA7N2j
          yYWBY0sP3k0rV+GqT8kR6Y8sF2sWaVGxY6f0Q5D5EYdCjY8/r3T8jGfJ6p4Q+W1P
          4t2Yj3YkVfZc+7jY4vw8W6F0Jl7qmfRcAaFlqXxj7gKwgYuV8R8jy1z0V2p9GgG6
          s7I9Xf0L9e1m3Vf4fMWkd5YyYNP2jK/+h2Z4WcE5yRfM7g0qY8g3y2/Zv4dO7gkP
          z9WjBuJ3n8D1xpQ=
          -----END CERTIFICATE-----
          EOF
          
          echo "✅ SSL sertifikası oluşturuldu: $(ls -la ssl/ca.pem)"
          echo "📊 SSL dosya boyutu: $(wc -c < ssl/ca.pem) byte"
          
          # Deploy script'i çalıştırılabilir yap
          chmod +x deploy.sh
          
          # Deploy script'i çalıştır
          ./deploy.sh
          
          echo "✅ GitHub Actions deployment tamamlandı!"