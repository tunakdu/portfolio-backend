name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 300s
        script: |
          echo "🚀 GitHub Actions deployment başlatılıyor..."
          cd /home/tunakdu/web/akduhan.com/public_html
          
          # SSL sertifikalarını ve önemli dosyaları koru
          cp -r ssl ssl_backup 2>/dev/null || true
          cp .env .env_backup 2>/dev/null || true
          
          # Git repository'yi temizle ve güncelle
          git reset --hard HEAD
          git clean -fd -e ssl/ -e .env -e storage/
          git pull origin master
          
          # Korunan dosyaları geri getir
          cp -r ssl_backup/* ssl/ 2>/dev/null || true
          cp .env_backup .env 2>/dev/null || true
          rm -rf ssl_backup .env_backup
          
          # MySQL SSL sertifikalarını kontrol et ve yükle
          if [ ! -f "ssl/ca.pem" ] || [ ! -s "ssl/ca.pem" ]; then
            echo "🔐 MySQL SSL sertifikaları yükleniyor..."
            mkdir -p ssl
            
            # MySQL 8.0 için doğru SSL sertifikalarını indir
            curl -sSL https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem -o ssl/ca.pem || \
            curl -sSL https://dl.cacerts.digicert.com/DigiCertGlobalRootCA.crt.pem -o ssl/ca.pem || \
            echo "# Placeholder SSL cert" > ssl/ca.pem
            
            echo "SSL sertifikası yüklendi: $(wc -l < ssl/ca.pem) satır"
          fi
          
          # Deploy script'i çalıştırılabilir yap
          chmod +x deploy.sh
          
          # Deploy script'i çalıştır
          ./deploy.sh
          
          echo "✅ GitHub Actions deployment tamamlandı!"