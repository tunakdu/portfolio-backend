name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || 22 }}
        timeout: 300s
        script: |
          echo "ğŸš€ GitHub Actions deployment baÅŸlatÄ±lÄ±yor..."
          cd /home/tunakdu/web/akduhan.com/public_html
          
          # SSL sertifikalarÄ±nÄ± ve Ã¶nemli dosyalarÄ± koru
          cp -r ssl ssl_backup 2>/dev/null || true
          cp .env .env_backup 2>/dev/null || true
          
          # Git repository'yi temizle ve gÃ¼ncelle
          git reset --hard HEAD
          git clean -fd -e ssl/ -e .env -e storage/
          git pull origin master
          
          # Korunan dosyalarÄ± geri getir
          cp -r ssl_backup/* ssl/ 2>/dev/null || true
          cp .env_backup .env 2>/dev/null || true
          rm -rf ssl_backup .env_backup
          
          # MySQL SSL sertifikalarÄ±nÄ± kontrol et ve yÃ¼kle
          if [ ! -f "ssl/ca.pem" ] || [ ! -s "ssl/ca.pem" ]; then
            echo "ğŸ” MySQL SSL sertifikalarÄ± yÃ¼kleniyor..."
            mkdir -p ssl
            
            # MySQL 8.0 iÃ§in doÄŸru SSL sertifikalarÄ±nÄ± indir
            curl -sSL https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem -o ssl/ca.pem || \
            curl -sSL https://dl.cacerts.digicert.com/DigiCertGlobalRootCA.crt.pem -o ssl/ca.pem || \
            echo "# Placeholder SSL cert" > ssl/ca.pem
            
            echo "SSL sertifikasÄ± yÃ¼klendi: $(wc -l < ssl/ca.pem) satÄ±r"
          fi
          
          # Deploy script'i Ã§alÄ±ÅŸtÄ±rÄ±labilir yap
          chmod +x deploy.sh
          
          # Deploy script'i Ã§alÄ±ÅŸtÄ±r
          ./deploy.sh
          
          echo "âœ… GitHub Actions deployment tamamlandÄ±!"